<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Idiom</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&family=DM+Sans:wght@400;500;600&family=Bungee&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sky-blue: #5B9BD5;
            --sky-light: #7CB9E8;
            --coral: #FF6B4A;
            --coral-dark: #E85A3A;
            --white: #FFFFFF;
            --cream: #FFF8F0;
            --navy: #1a1f36;
            --gold: #FFD166;
            --green: #22C55E;
            --red: #EF4444;
            --text-secondary: #4a5568;
            --text-muted: #718096;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(180deg, var(--sky-light) 0%, var(--sky-blue) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .game-container {
            background: var(--white);
            border-radius: 28px;
            padding: 28px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* LOGO */
        .logo {
            font-family: 'Bungee', cursive;
            font-size: 36px;
            text-align: center;
            margin-bottom: 6px;
            line-height: 1.1;
            letter-spacing: -1px;
        }

        .logo .daily {
            color: var(--navy);
            display: block;
            text-shadow: 3px 3px 0 var(--coral);
        }

        .logo .idiom {
            color: var(--coral);
            display: block;
            text-shadow: 3px 3px 0 var(--navy);
        }

        .logo-tagline {
            font-family: 'Nunito', sans-serif;
            font-size: 15px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .logo-sub {
            font-size: 13px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 24px;
            font-weight: 500;
            font-style: italic;
        }

        /* VIDEO */
        .video-container {
            background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
            border-radius: 20px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            overflow: hidden;
            border: 2px solid rgba(0,0,0,0.05);
        }

        .video-container video,
        .video-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 18px;
        }

        .video-caption {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .video-caption strong {
            color: var(--navy);
            font-weight: 700;
        }

        /* STATS ROW */
        .stats-row-top {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-pill {
            background: var(--cream);
            border-radius: 30px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid rgba(0,0,0,0.05);
        }

        .stat-pill .icon { font-size: 18px; }

        .stat-pill .text {
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--navy);
        }

        .stat-pill.streak {
            background: linear-gradient(135deg, var(--gold) 0%, #E5B84D 100%);
            border: none;
        }

        .stat-pill.xp {
            background: linear-gradient(135deg, var(--coral) 0%, var(--coral-dark) 100%);
            border: none;
        }

        .stat-pill.xp .text { color: white; }

        /* BUTTONS */
        .btn {
            font-family: 'Nunito', sans-serif;
            font-size: 16px;
            font-weight: 800;
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--coral) 0%, var(--coral-dark) 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 107, 74, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 10px 30px rgba(255, 107, 74, 0.5);
        }

        .btn-secondary {
            background: var(--cream);
            color: var(--navy);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid rgba(0,0,0,0.05);
        }

        .btn-secondary:hover {
            background: #fff;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, #E5B84D 100%);
            color: var(--navy);
            box-shadow: 0 6px 20px rgba(255, 209, 102, 0.4);
        }

        /* DIFFICULTY GRID */
        .difficulty-title {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: var(--navy);
            text-align: center;
            margin-bottom: 20px;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .diff-btn {
            padding: 20px 10px;
            border: 2px solid rgba(0,0,0,0.05);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            background: var(--cream);
        }

        .diff-btn:hover {
            transform: translateY(-4px);
            border-color: var(--coral);
            background: rgba(255, 107, 74, 0.08);
            box-shadow: 0 8px 25px rgba(255, 107, 74, 0.2);
        }

        .diff-btn .stars {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .diff-btn .xp-reward {
            font-family: 'Nunito', sans-serif;
            font-size: 15px;
            font-weight: 800;
            color: var(--coral);
            display: block;
        }

        .diff-btn .diff-desc {
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-top: 6px;
        }

        /* MODE TITLE */
        .mode-title {
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* WORD TILES */
        .word-area {
            background: var(--cream);
            border: 2px dashed rgba(0,0,0,0.1);
            border-radius: 16px;
            padding: 20px;
            min-height: 70px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            transition: border-color 0.2s ease;
        }

        .word-area:hover {
            border-color: var(--coral);
        }

        .word-tiles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .word-tile {
            background: var(--white);
            border: 2px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 14px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 16px;
            font-weight: 800;
            color: var(--navy);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .word-tile:hover {
            background: var(--coral);
            border-color: var(--coral);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 107, 74, 0.3);
        }

        .word-tile.selected {
            background: #e0e0e0;
            color: #999;
            cursor: default;
            border-color: #e0e0e0;
        }

        .word-tile.selected:hover {
            transform: none;
            box-shadow: none;
        }

        .word-tile.in-answer {
            background: var(--coral);
            border-color: var(--coral);
            color: white;
        }

        /* INPUT */
        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
        }

        .text-input {
            width: 100%;
            padding: 16px;
            border: 2px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            transition: border-color 0.3s;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--coral);
        }

        /* BLANKS */
        .fill-blanks {
            font-size: 18px;
            line-height: 2.2;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            color: var(--navy);
        }

        .blank-input {
            display: inline-block;
            border: none;
            border-bottom: 3px solid var(--coral);
            background: transparent;
            font-size: 18px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            padding: 4px 8px;
            margin: 0 6px;
            width: 100px;
            text-align: center;
            color: var(--navy);
        }

        .blank-input:focus {
            outline: none;
            border-bottom-color: var(--coral-dark);
        }

        /* ANSWER REVEAL */
        .answer-title {
            font-family: 'Bungee', cursive;
            font-size: 26px;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        .answer-title.correct {
            color: var(--green);
            text-shadow: 2px 2px 0 var(--navy);
        }

        .answer-title.incorrect {
            color: var(--red);
            text-shadow: 2px 2px 0 var(--navy);
        }

        .idiom-display {
            font-family: 'Nunito', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--navy);
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--cream);
            border-radius: 16px;
        }

        /* INFO TABS */
        .info-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .info-tab {
            flex: 1;
            padding: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            background: var(--cream);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .info-tab.active {
            background: var(--navy);
            color: white;
        }

        .info-tab:hover:not(.active) {
            background: #f0f0f0;
        }

        .info-content {
            background: var(--cream);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .info-content p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .translate-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--coral);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 12px;
            font-weight: 700;
            font-family: 'Nunito', sans-serif;
        }

        .translate-btn:hover {
            text-decoration: underline;
        }

        /* COMPLETE SCREEN */
        .celebration {
            font-size: 64px;
            text-align: center;
            margin-bottom: 12px;
        }

        .result-title {
            font-family: 'Bungee', cursive;
            font-size: 28px;
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: -1px;
        }

        .result-title.correct {
            color: var(--green);
            text-shadow: 2px 2px 0 var(--navy);
        }

        .result-title.incorrect {
            color: var(--red);
            text-shadow: 2px 2px 0 var(--navy);
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: var(--cream);
            border-radius: 16px;
            padding: 16px 20px;
            text-align: center;
            min-width: 85px;
            border: 2px solid rgba(0,0,0,0.05);
        }

        .stat-box .number {
            font-family: 'Nunito', sans-serif;
            font-size: 20px;
            color: var(--navy);
            font-weight: 900;
        }

        .stat-box .number.coral { color: var(--coral); }

        .stat-box .label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .answer-reminder {
            background: var(--navy);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .answer-reminder .idiom-text {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: var(--gold);
        }

        /* KO-FI */
        .kofi-banner {
            background: linear-gradient(135deg, #FF5E5B 0%, #D94343 100%);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            margin-top: 16px;
        }

        .kofi-banner p {
            font-size: 13px;
            color: white;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .kofi-banner a {
            display: inline-block;
            background: white;
            color: #FF5E5B;
            font-family: 'Nunito', sans-serif;
            font-size: 13px;
            font-weight: 800;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
        }

        /* ARCHIVE */
        .archive-item {
            background: var(--cream);
            border-radius: 14px;
            padding: 16px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .archive-item:hover {
            transform: scale(1.01);
            border-color: var(--coral);
        }

        .archive-item.completed {
            border-left: 4px solid var(--green);
            background: rgba(34, 197, 94, 0.06);
        }

        .archive-item.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .archive-item.locked:hover {
            transform: none;
            border-color: transparent;
        }

        .archive-day {
            font-family: 'Nunito', sans-serif;
            font-size: 15px;
            color: var(--navy);
            font-weight: 800;
        }

        .archive-date {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .archive-answer {
            font-size: 13px;
            color: var(--green);
            margin-top: 4px;
            font-weight: 600;
        }

        .archive-status {
            font-size: 20px;
        }

        /* BACK BUTTON */
        .back-btn {
            font-family: 'Nunito', sans-serif;
            font-size: 14px;
            font-weight: 700;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0;
            transition: color 0.2s ease;
        }

        .back-btn:hover {
            color: var(--coral);
        }

        /* TOMORROW MESSAGE */
        .tomorrow-message {
            background: var(--cream);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .tomorrow-message h3 {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: var(--navy);
            margin-bottom: 8px;
        }

        .tomorrow-message p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* FOOTER */
        .footer-legal {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .footer-legal a {
            font-size: 11px;
            color: var(--text-muted);
            text-decoration: none;
        }

        .footer-legal a:hover {
            color: var(--coral);
        }

        /* TOAST */
        @keyframes slideIn {
            from { transform: translate(-50%, -100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100px); opacity: 0; }
        }

        /* EMOJI PLACEHOLDER */
        .emoji-placeholder {
            font-size: 80px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- PASSWORD GATE -->
    <div id="gate" class="game-container" style="text-align: center;">
        <div class="logo">
            <span class="daily">DAILY</span>
            <span class="idiom">IDIOM</span>
        </div>
        <div class="logo-tagline">Master English Expressions</div>
        
        <div style="margin: 40px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">üöÄ</div>
            <h2 style="font-family: 'Nunito', sans-serif; font-size: 24px; color: var(--navy); margin-bottom: 8px;">Coming Soon!</h2>
            <p style="color: var(--text-muted); font-size: 15px;">Launching January 17th, 2026</p>
        </div>
        
        <div class="input-group">
            <input type="password" id="gatePassword" class="text-input" placeholder="Enter password" style="text-align: center;">
        </div>
        <button class="btn btn-primary" onclick="checkGate()">Enter</button>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05);">
            <p style="color: var(--text-muted); font-size: 13px;">Follow us for updates</p>
            <p style="color: var(--coral); font-weight: 700; font-size: 14px; margin-top: 8px;">@dailyidiomgame</p>
        </div>
    </div>
    
    <div id="app" class="game-container" style="display: none;"></div>

    <script>
        // PASSWORD GATE
        const GATE_PASSWORD = 'H0m3r15mym8';
        
        function checkGate() {
            const input = document.getElementById('gatePassword').value;
            if (input === GATE_PASSWORD) {
                document.getElementById('gate').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                sessionStorage.setItem('gateUnlocked', 'true');
            } else {
                document.getElementById('gatePassword').style.borderColor = '#EF4444';
                document.getElementById('gatePassword').value = '';
                document.getElementById('gatePassword').placeholder = 'Try again...';
            }
        }
        
        // Check if already unlocked this session
        if (sessionStorage.getItem('gateUnlocked') === 'true') {
            document.getElementById('gate').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }
        
        // Allow Enter key
        document.getElementById('gatePassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkGate();
        });
    
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        // Launch date: Jan 17, 2026
        const LAUNCH_DATE = new Date('2026-01-17T00:00:00Z');
        
        // XP values per difficulty
        const XP_VALUES = { easy: 10, medium: 50, hard: 100 };
        
        function getDaysSinceLaunch() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const launchDate = new Date(LAUNCH_DATE);
            launchDate.setHours(0, 0, 0, 0);
            const diffTime = today - launchDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays) + 1;  // Day 1 = launch day
        }
        
        function getTodaysDate() {
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return new Date().toLocaleDateString('en-GB', options);
        }
        
        function getDateForDay(dayNumber) {
            const date = new Date(LAUNCH_DATE);
            date.setDate(date.getDate() + dayNumber - 1);
            const options = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        }

        // ==========================================
        // GAME STATE
        // ==========================================
        
        let state = {
            screen: 'landing',
            difficulty: null,
            selectedWords: [],
            usedWordIndices: [],
            shuffledWords: null,
            userAnswer: '',
            blank1: '',
            blank2: '',
            blank3: '',
            isCorrect: false,
            streak: parseInt(localStorage.getItem('idiomStreak') || '0'),
            totalXP: parseInt(localStorage.getItem('idiomTotalXP') || '0'),
            hasPlayedToday: localStorage.getItem('lastPlayedDay') === getDayOfYear().toString(),
            activeTab: 'meaning',
            selectedLanguage: 'es',
            translatedContent: null,
            isPlayingArchive: false,
            archiveIdiomIndex: null
        };

        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function saveProgress() {
            localStorage.setItem('idiomStreak', state.streak.toString());
            localStorage.setItem('idiomTotalXP', state.totalXP.toString());
            localStorage.setItem('lastPlayedDay', getDayOfYear().toString());
        }

        function markTodayComplete() {
            localStorage.setItem('lastPlayedDay', getDayOfYear().toString());
            state.hasPlayedToday = true;
        }

        // ==========================================
        // IDIOM LIBRARY
        // ==========================================
        
        const idiomLibrary = [
            {
                text: "break the ice",
                meaning: "To do or say something that makes people feel more comfortable in a social situation, especially when meeting for the first time.",
                etymology: "This phrase comes from the 16th century, when ships would literally break ice to clear a path for other vessels. It soon became a metaphor for clearing the way in social situations - making that first move to start a conversation.",
                examples: ["She told a joke to break the ice at the meeting.", "Playing a game helped us break the ice on the first day of class.", "Let's play an ice-breaker before we get started."],
                words: ["break", "the", "ice"],
                blanks: {answers: ["break", "ice"]},
                emoji: "üßä",
                image: "idiom_images_pixel/idiom_01_break_the_ice_sora.mp4",
                hardModeAccepts: ["break the ice", "break ice", "breaking the ice", "broke the ice", "ice breaker", "icebreaker", "ice-breaker", "an ice-breaker"]
            },
            {
                text: "spill the beans",
                meaning: "To reveal secret information, either accidentally or deliberately.",
                etymology: "One popular theory links this to ancient Greece, where people voted by placing beans in jars - white for yes, black for no. If someone knocked over the jar, the beans would spill and reveal the secret vote! The phrase first appeared in American English around 1919.",
                examples: ["Come on, spill the beans! What happened?", "She finally spilled the beans about her promotion.", "He promised not to spill the beans about the surprise party."],
                words: ["spill", "the", "beans"],
                blanks: {answers: ["spill", "beans"]},
                emoji: "ü´ò",
                image: "idiom_images_pixel/idiom_02_spill_the_beans_sora_v2.mp4",
                hardModeAccepts: ["spill the beans", "spill beans", "spilling the beans", "spilled the beans", "spilt the beans", "to spill the beans"]
            },
            {
                text: "piece of cake",
                meaning: "Something that is very easy to do.",
                etymology: "This dates to the 1930s when the British Royal Air Force would describe an easy flying mission as being \"a piece of cake\" - as sweet and effortless as eating a slice of cake.",
                examples: ["The test was a piece of cake.", "Don't worry, fixing this problem will be a piece of cake.", "Once you've learned it, it becomes a piece of cake."],
                words: ["piece", "of", "cake"],
                blanks: {answers: ["piece", "cake"]},
                emoji: "üç∞",
                image: "idiom_images_pixel/idiom_03_piece_of_cake_sora.mp4",
                hardModeAccepts: ["piece of cake", "piece a cake", "peice of cake", "a piece of cake"]
            },
            {
                text: "hit the nail on the head",
                meaning: "To be exactly right about the cause of a situation or problem.",
                etymology: "This phrase dates back to at least the 1500s. It comes from carpentry: hitting a nail squarely on the head drives it in properly, while missing causes damage. The expression quickly became a metaphor for precision and accuracy.",
                examples: ["You've hit the nail on the head ‚Äî that's exactly the problem.", "Her comment really hit the nail on the head.", "I think he's finally hitting the nail on the head with this new idea."],
                words: ["hit", "the", "nail", "on", "the", "head"],
                blanks: {answers: ["nail", "head"]},
                emoji: "üî®",
                image: "idiom_images_pixel/idiom_05_hit_the_nail_on_the_head_sora_v2.mp4",
                hardModeAccepts: ["hit the nail on the head", "hit nail on head", "hit the nail on head", "hitting the nail on the head", "hits the nail on the head"]
            },
            {
                text: "let the cat out of the bag",
                meaning: "To reveal a secret, usually by accident.",
                etymology: "The phrase likely dates from the 18th century. One widely cited explanation links it to market fraud, where dishonest sellers would substitute a cat for a piglet in a bag. Opening the bag exposed the deception, revealing the secret.",
                examples: ["He let the cat out of the bag about the surprise party.", "She accidentally let the cat out of the bag at dinner.", "Try not to let the cat out of the bag before Friday."],
                words: ["let", "the", "cat", "out", "of", "the", "bag"],
                blanks: {answers: ["cat", "bag"]},
                emoji: "üê±",
                image: "idiom_images_pixel/idiom_06_let_the_cat_out_of_the_bag_sora_v3.mp4",
                hardModeAccepts: ["let the cat out of the bag", "let cat out of bag", "let the cat out the bag", "letting the cat out of the bag", "lets the cat out of the bag", "the cat's out of the bag", "the cats out of the bag", "cats out of the bag", "cat's out of the bag", "cat out of the bag", "to let the cat out of the bag"]
            },
            {
                text: "raining cats and dogs",
                meaning: "Raining very heavily.",
                etymology: "One popular theory suggests that in 17th century England, heavy rain would wash stray animals through the streets. Another links it to Norse mythology, where cats symbolised rain and dogs represented wind. Whatever its true origin, the phrase has meant heavy rain since the 1700s.",
                examples: ["It's raining cats and dogs, so we should stay inside.", "Yesterday it rained cats and dogs all afternoon.", "Don't forget your umbrella ‚Äî it's raining cats and dogs out there."],
                words: ["raining", "cats", "and", "dogs"],
                blanks: {answers: ["cats", "dogs"]},
                emoji: "üåßÔ∏è",
                image: "idiom_images_pixel/idiom_07_raining_cats_and_dogs_sora.mp4",
                hardModeAccepts: ["raining cats and dogs", "its raining cats and dogs", "it's raining cats and dogs", "rain cats and dogs", "rains cats and dogs", "to rain cats and dogs"]
            },
            {
                text: "under the weather",
                meaning: "Feeling ill or unwell.",
                etymology: "This expression comes from maritime language. When sailors felt sick, they would go below deck to escape bad weather and rough seas. Being \"under the weather\" came to mean feeling unwell. The phrase appears in this sense from the early 19th century.",
                examples: ["I'm feeling a bit under the weather today.", "He was under the weather, so he stayed home from work.", "She looked under the weather yesterday."],
                words: ["under", "the", "weather"],
                blanks: {answers: ["under", "weather"]},
                emoji: "‚òÅÔ∏è",
                image: "idiom_images_pixel/idiom_09_under_the_weather_sora.mp4",
                hardModeAccepts: ["under the weather", "under weather", "feeling under the weather"]
            },
            {
                text: "kick the bucket",
                meaning: "To die.",
                etymology: "The most accepted theory links this to animal slaughter. A wooden beam called a \"bucket\" (from Old French 'buquet') was used to hang animals, and their death throes involved kicking against it. The phrase has meant 'to die' since the 18th century.",
                examples: ["When I kick the bucket, I want to be remembered for my kindness.", "He joked that he'd learn to dance before he kicked the bucket.", "She said her grandfather kicked the bucket peacefully in his sleep."],
                words: ["kick", "the", "bucket"],
                blanks: {answers: ["kick", "bucket"]},
                emoji: "ü™£",
                image: "idiom_images_pixel/idiom_10_kick_the_bucket_sora.mp4",
                hardModeAccepts: ["kick the bucket", "kick bucket", "kicked the bucket", "kicking the bucket", "kicks the bucket", "to kick the bucket"]
            },
            {
                text: "barking up the wrong tree",
                meaning: "To be wrong about the reason for something or to pursue a mistaken course of action.",
                etymology: "This American idiom dates to the early 19th century. It comes from hunting, where dogs sometimes barked at the wrong tree after prey had escaped elsewhere.",
                examples: ["If you think I broke it, you're barking up the wrong tree.", "The police were barking up the wrong tree with their latest suspect.", "He's barking up the wrong tree if he thinks she's to blame."],
                words: ["barking", "up", "the", "wrong", "tree"],
                blanks: {answers: ["barking", "tree"]},
                emoji: "üêï",
                image: "idiom_images_pixel/idiom_11_barking_up_the_wrong_tree_sora.mp4",
                hardModeAccepts: ["barking up the wrong tree", "barking up wrong tree", "bark up the wrong tree", "barked up the wrong tree", "to bark up the wrong tree", "you're barking up the wrong tree", "youre barking up the wrong tree"]
            },
            {
                text: "kill two birds with one stone",
                meaning: "To achieve two goals with a single action.",
                etymology: "One popular theory links this to Greek mythology. When Daedalus was imprisoned with his son Icarus, he threw stones at birds overhead to collect feathers for building wings to escape. With practice, he learned to strike one bird and hit a second with the ricochet - killing two birds with one stone!",
                examples: ["Studying on the train helps me kill two birds with one stone.", "He called his friend while driving home to kill two birds with one stone.", "She tidied her room and found her necklace ‚Äî two birds with one stone."],
                words: ["kill", "two", "birds", "with", "one", "stone"],
                blanks: {answers: ["two", "birds", "stone"]},
                emoji: "ü™®",
                image: "idiom_images_pixel/idiom_12_kill_two_birds_with_one_stone_sora.mp4",
                hardModeAccepts: ["kill two birds with one stone", "kill 2 birds with one stone", "kill two birds with 1 stone", "kill 2 birds with 1 stone", "killing two birds with one stone", "kills two birds with one stone"]
            },
            {
                text: "caught between a rock and a hard place",
                meaning: "Faced with two equally difficult or unpleasant choices.",
                etymology: "One popular theory traces this to 1920s Arizona copper miners who had to choose between dangerous working conditions (the rock) or losing their jobs during a strike (the hard place). The phrase captures that feeling of having no good options.",
                examples: ["I'm caught between a rock and a hard place ‚Äî both choices are bad.", "There was no good option; she was caught between a rock and a hard place.", "He felt caught between a rock and a hard place after the argument."],
                words: ["caught", "between", "a", "rock", "and", "a", "hard", "place"],
                blanks: {answers: ["rock", "hard", "place"]},
                emoji: "ü™®",
                image: "idiom_images_pixel/idiom_14_caught_between_a_rock_and_a_hard_place_sora.mp4",
                hardModeAccepts: ["caught between a rock and a hard place", "caught between rock and hard place", "caught between a rock and hard place", "between a rock and a hard place", "catch between a rock and a hard place", "to be caught between a rock and a hard place"]
            },
            {
                text: "burning bridges",
                meaning: "To destroy relationships or opportunities, making it impossible to return to a previous situation.",
                etymology: "The phrase comes from military strategy, where armies destroyed bridges after crossing them to prevent retreat or enemy pursuit. It has been used metaphorically since the 19th century to describe irreversible personal or professional actions.",
                examples: ["She burned those bridges a long time ago.", "Don't burn bridges ‚Äî you might need those connections later.", "He's careful not to burn any bridges at work."],
                words: ["burning", "bridges"],
                blanks: {answers: ["burning", "bridges"]},
                emoji: "üî•",
                image: "idiom_images_pixel/idiom_15_burning_bridges_sora_v2.mp4",
                hardModeAccepts: ["burning bridges", "burn bridges", "burned bridges", "burns bridges", "burning your bridges", "burn your bridges"]
            }
        ];

        // ==========================================
        // IDIOM SELECTION
        // ==========================================
        
        // Secret debug override: ?debug=H0m3r15mym8&day=5
        function getDebugDayOverride() {
            const params = new URLSearchParams(window.location.search);
            const debug = params.get('debug');
            const day = params.get('day');
            if (debug === 'H0m3r15mym8' && day) {
                const dayNum = parseInt(day);
                if (dayNum >= 1 && dayNum <= idiomLibrary.length) {
                    return dayNum;
                }
            }
            return null;
        }
        
        function getTodaysIdiomIndex() {
            const debugDay = getDebugDayOverride();
            if (debugDay !== null) {
                return debugDay - 1; // Day 1 = index 0
            }
            const dayNumber = getDaysSinceLaunch();
            return (dayNumber - 1) % idiomLibrary.length;
        }
        
        // Override day number for display if debug active
        function getDisplayDayNumber() {
            const debugDay = getDebugDayOverride();
            if (debugDay !== null) {
                return debugDay;
            }
            return getDaysSinceLaunch();
        }

        let currentIdiomIndex = getTodaysIdiomIndex();
        let idiom = idiomLibrary[currentIdiomIndex];

        // Pixel Trophy SVG
        const pixelTrophy = `<svg width="40" height="40" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="image-rendering: pixelated;">
            <rect x="5" y="1" width="6" height="1" fill="#FFD700"/>
            <rect x="4" y="2" width="8" height="5" fill="#FFD700"/>
            <rect x="5" y="7" width="6" height="1" fill="#FFD700"/>
            <rect x="2" y="2" width="2" height="1" fill="#FFD700"/>
            <rect x="1" y="3" width="2" height="1" fill="#FFD700"/>
            <rect x="1" y="4" width="2" height="1" fill="#FFD700"/>
            <rect x="2" y="5" width="2" height="1" fill="#FFD700"/>
            <rect x="12" y="2" width="2" height="1" fill="#FFD700"/>
            <rect x="13" y="3" width="2" height="1" fill="#FFD700"/>
            <rect x="13" y="4" width="2" height="1" fill="#FFD700"/>
            <rect x="12" y="5" width="2" height="1" fill="#FFD700"/>
            <rect x="5" y="3" width="1" height="2" fill="#FFFACD"/>
            <rect x="7" y="8" width="2" height="2" fill="#DAA520"/>
            <rect x="5" y="10" width="6" height="1" fill="#DAA520"/>
            <rect x="4" y="11" width="8" height="2" fill="#B8860B"/>
            <rect x="3" y="13" width="10" height="1" fill="#8B6914"/>
        </svg>`;

        // ==========================================
        // RENDER FUNCTION
        // ==========================================
        
        function render() {
            const app = document.getElementById('app');
            // Show archive day number if playing from archive, otherwise today's day
            const dayNumber = state.isPlayingArchive ? (state.archiveIdiomIndex + 1) : getDisplayDayNumber();
            
            // ==========================================
            // SCREEN: LANDING
            // ==========================================
            if (state.screen === 'landing') {
                // Debug mode bypasses "already played" state for testing
                const isDebugMode = getDebugDayOverride() !== null;
                const showReturnState = state.hasPlayedToday && !isDebugMode;
                
                if (showReturnState) {
                    // RETURN STATE - Already completed today
                    app.innerHTML = `
                        <div class="logo">
                            <span class="daily">DAILY</span>
                            <span class="idiom">IDIOM</span>
                        </div>
                        
                        <div class="stats-row-top">
                            <div class="stat-pill streak">
                                <span class="icon">üî•</span>
                                <span class="text">${state.streak} streak</span>
                            </div>
                            <div class="stat-pill xp">
                                <span class="icon">‚ö°</span>
                                <span class="text">${state.totalXP} XP</span>
                            </div>
                        </div>
                        
                        <div class="tomorrow-message">
                            <h3>You're all done for today! üéâ</h3>
                            <p>Come back tomorrow for a new idiom</p>
                        </div>
                        
                        <div class="video-container">
                            ${renderMedia(idiom)}
                        </div>
                        <div class="video-caption"><strong>Day ${dayNumber}</strong> ¬∑ "${idiom.text}" ‚úì</div>
                        
                        <button class="btn btn-secondary" onclick="startPractice()">üîÑ Practice Again</button>
                        <button class="btn btn-secondary" onclick="goToScreen('archive')" style="display: ${dayNumber === 1 ? 'none' : 'block'};">üìö Play Past Idioms</button>
                        
                        <div class="footer-legal">
                            <a href="#">Terms of Service</a>
                            <a href="#">Privacy Policy</a>
                        </div>
                    `;
                } else {
                    // FRESH LANDING - Not played today
                    app.innerHTML = `
                        <div class="logo">
                            <span class="daily">DAILY</span>
                            <span class="idiom">IDIOM</span>
                        </div>
                        <div class="logo-tagline">Master English Expressions</div>
                        <div class="logo-sub">Play it ¬∑ Learn it ¬∑ Use it</div>
                        
                        <div class="video-container">
                            ${renderMedia(idiom)}
                        </div>
                        <div class="video-caption"><strong>Day ${dayNumber}</strong></div>
                        
                        <button class="btn btn-primary" onclick="goToScreen('difficulty')">‚ñ∂ Play</button>
                        
                        <div class="footer-legal">
                            <a href="#">Terms of Service</a>
                            <a href="#">Privacy Policy</a>
                        </div>
                    `;
                }
            }
            
            // ==========================================
            // SCREEN: DIFFICULTY SELECT
            // ==========================================
            else if (state.screen === 'difficulty') {
                const backDestination = state.isPlayingArchive ? 'archive' : 'landing';
                app.innerHTML = `
                    <button class="back-btn" onclick="goToScreen('${backDestination}')">‚Üê Back</button>
                    
                    <div class="video-container" style="height: 200px;">
                        ${renderMedia(idiom)}
                    </div>
                    <div class="video-caption"><strong>Day ${dayNumber}</strong></div>
                    
                    <div class="difficulty-title">Choose your challenge</div>
                    
                    <div class="difficulty-grid">
                        <div class="diff-btn" onclick="selectDifficulty('easy')">
                            <span class="stars">‚≠ê</span>
                            <span class="xp-reward">+10 XP</span>
                            <span class="diff-desc">Reorder the words</span>
                        </div>
                        <div class="diff-btn" onclick="selectDifficulty('medium')">
                            <span class="stars">‚≠ê‚≠ê</span>
                            <span class="xp-reward">+50 XP</span>
                            <span class="diff-desc">Fill in the blanks</span>
                        </div>
                        <div class="diff-btn" onclick="selectDifficulty('hard')">
                            <span class="stars">‚≠ê‚≠ê‚≠ê</span>
                            <span class="xp-reward">+100 XP</span>
                            <span class="diff-desc">Type the full idiom</span>
                        </div>
                    </div>
                `;
            }
            
            // ==========================================
            // SCREEN: SOLVE (GAMEPLAY)
            // ==========================================
            else if (state.screen === 'solve') {
                let solveContent = '';
                const difficultyStars = state.difficulty === 'easy' ? '‚≠ê' : state.difficulty === 'medium' ? '‚≠ê‚≠ê' : '‚≠ê‚≠ê‚≠ê';
                const xpReward = XP_VALUES[state.difficulty];
                
                if (state.difficulty === 'easy') {
                    // Shuffle ONCE and store
                    if (!state.shuffledWords) {
                        let shuffled = [...idiom.words];
                        let attempts = 0;
                        do {
                            shuffled = [...idiom.words].sort(() => Math.random() - 0.5);
                            attempts++;
                        } while (shuffled.join(' ') === idiom.words.join(' ') && attempts < 10);
                        state.shuffledWords = shuffled;
                    }
                    
                    const shuffled = state.shuffledWords;
                    const usedIndices = state.usedWordIndices || [];
                    
                    solveContent = `
                        <div class="word-area">
                            ${state.selectedWords.length === 0 ? 
                                '<div style="color: #999; font-size: 14px;">Tap words below to build the idiom...</div>' :
                                state.selectedWords.map((w, i) => 
                                    `<div class="word-tile in-answer" onclick="removeWord(${i})">${w}</div>`
                                ).join('')
                            }
                        </div>
                        
                        <div class="word-tiles-container">
                            ${shuffled.map((word, index) => 
                                `<div class="word-tile ${usedIndices.includes(index) ? 'selected' : ''}" 
                                     onclick="addWordByIndex(${index}, '${word}')">
                                    ${word}
                                </div>`
                            ).join('')}
                        </div>
                    `;
                }
                
                else if (state.difficulty === 'medium') {
                    const blanksText = generateBlanksText();
                    solveContent = `
                        <div class="fill-blanks">
                            ${blanksText}
                        </div>
                    `;
                }
                
                else if (state.difficulty === 'hard') {
                    solveContent = `
                        <div class="input-group">
                            <label class="input-label">Type the complete idiom:</label>
                            <input type="text" class="text-input" id="userAnswer"
                                   value="${state.userAnswer}"
                                   oninput="updateAnswer(this.value)"
                                   placeholder="Enter the idiom..."
                                   autocomplete="off">
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <button class="back-btn" onclick="goToScreen('difficulty')">‚Üê Back</button>
                    
                    <div class="mode-title">${difficultyStars} +${xpReward} XP</div>
                    
                    <div class="video-container" style="height: 200px;">
                        ${renderMedia(idiom)}
                    </div>
                    
                    ${solveContent}
                    
                    <button class="btn btn-primary" onclick="checkAnswer()">Check Answer</button>
                `;
            }
            
            // ==========================================
            // SCREEN: ANSWER REVEAL
            // ==========================================
            else if (state.screen === 'answer') {
                const isCorrect = state.isCorrect;
                const activeTab = state.activeTab || 'meaning';
                
                let tabContent = '';
                if (activeTab === 'meaning') {
                    tabContent = `<p>${idiom.meaning}</p>`;
                } else if (activeTab === 'useit') {
                    // Bold the idiom text in examples
                    tabContent = idiom.examples.map(ex => {
                        const boldedEx = ex.replace(new RegExp(idiom.text, 'gi'), `<strong>$&</strong>`);
                        return `<p style="margin-bottom: 10px;">‚Ä¢ ${boldedEx}</p>`;
                    }).join('');
                } else if (activeTab === 'origin') {
                    tabContent = `<p>${idiom.etymology}</p>`;
                }
                
                app.innerHTML = `
                    <div class="answer-title ${isCorrect ? 'correct' : 'incorrect'}">
                        ${isCorrect ? 'CORRECT!' : 'NOT QUITE!'}
                    </div>
                    
                    <div class="idiom-display">"${idiom.text}"</div>
                    
                    <div class="info-tabs">
                        <button class="info-tab ${activeTab === 'meaning' ? 'active' : ''}" onclick="setTab('meaning')">Meaning</button>
                        <button class="info-tab ${activeTab === 'useit' ? 'active' : ''}" onclick="setTab('useit')">Use it</button>
                        <button class="info-tab ${activeTab === 'origin' ? 'active' : ''}" onclick="setTab('origin')">Origin</button>
                    </div>
                    
                    <div class="info-content">
                        ${tabContent}
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('complete')">Next ‚Üí</button>
                `;
            }
            
            // ==========================================
            // SCREEN: COMPLETE
            // ==========================================
            else if (state.screen === 'complete') {
                const levelText = state.isPlayingArchive ? `Day ${dayNumber} complete!` : "Today's level complete!";
                const subText = state.isPlayingArchive 
                    ? "Try another day or come back tomorrow"
                    : "Come back tomorrow for a new idiom";
                const tryAgainSubText = state.isPlayingArchive
                    ? "Try again to earn the trophy üèÜ"
                    : "Try again to earn the trophy üèÜ";
                
                const doneMessage = state.isCorrect 
                    ? `<div style="margin-bottom: 8px;">${pixelTrophy}</div>
                       <div style="font-family: 'Nunito', sans-serif; font-weight: 800; color: var(--navy); font-size: 18px;">${levelText}</div>
                       <div style="font-family: 'DM Sans', sans-serif; color: var(--text-muted); margin-top: 4px;">${subText}</div>`
                    : `<div style="font-family: 'Nunito', sans-serif; font-weight: 800; color: var(--navy); font-size: 18px;">${levelText}</div>
                       <div style="font-family: 'DM Sans', sans-serif; color: var(--text-muted); margin-top: 4px;">${tryAgainSubText}</div>`;
                
                app.innerHTML = `
                    <button class="back-btn" onclick="goToScreen('answer')">‚Üê Back</button>
                    
                    <div class="logo">
                        <span class="daily">DAILY</span>
                        <span class="idiom">IDIOM</span>
                    </div>
                    
                    <div class="stats-row-top">
                        <div class="stat-pill streak">
                            <span class="icon">üî•</span>
                            <span class="text">${state.streak} streak</span>
                        </div>
                        <div class="stat-pill xp">
                            <span class="icon">‚ö°</span>
                            <span class="text">${state.totalXP} XP</span>
                        </div>
                    </div>
                    
                    <div class="done-message" style="background: var(--cream); border-radius: 14px; padding: 16px; text-align: center; margin-bottom: 16px;">
                        ${doneMessage}
                    </div>
                    
                    <div class="video-container" style="height: 200px;">
                        ${renderMedia(idiom)}
                    </div>
                    <div class="video-caption"><strong>Day ${dayNumber}</strong> ¬∑ "${idiom.text}" ${state.isCorrect ? '‚úì' : ''}</div>
                    
                    <button class="btn btn-primary" onclick="startPractice()">üîÑ ${state.isCorrect ? 'Practice Again' : 'Try Again'}</button>
                    <button class="btn btn-gold" onclick="shareResult()" style="display: ${state.isCorrect ? 'block' : 'none'};">üì≤ Share with Friends</button>
                    <button class="btn btn-secondary" onclick="goToScreen('archive')" style="display: ${dayNumber === 1 ? 'none' : 'block'};">üìö Play Past Idioms</button>
                `;
            }
            
            // ==========================================
            // SCREEN: ARCHIVE
            // ==========================================
            else if (state.screen === 'archive') {
                const availableCount = dayNumber === 1 ? 0 : Math.min(dayNumber - 1, idiomLibrary.length);
                
                let archiveItems = '';
                for (let i = 0; i < availableCount; i++) {
                    const item = idiomLibrary[i];
                    
                    archiveItems += `
                        <div class="archive-item" onclick="playArchiveIdiom(${i})">
                            <div>
                                <div class="archive-day">Day ${i + 1}</div>
                                <div class="archive-date">"${item.text}"</div>
                            </div>
                            <span class="archive-status">‚ñ∂Ô∏è</span>
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <button class="back-btn" onclick="goToScreen('landing')">‚Üê Home</button>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-family: 'Bungee', cursive; font-size: 24px; color: var(--navy);">üìö Archive</div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${archiveItems || '<div style="text-align: center; color: #999; padding: 40px;">No past idioms yet.<br>Come back tomorrow!</div>'}
                    </div>
                `;
            }
            
            // ==========================================
            // SCREEN: TRANSLATE
            // ==========================================
            else if (state.screen === 'translate') {
                const selectedLang = state.selectedLanguage || 'es';
                
                app.innerHTML = `
                    <button class="back-btn" onclick="goToScreen('answer')">‚Üê Back</button>
                    
                    <div class="idiom-display">"${idiom.text}"</div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; color: #856404;">
                        ‚ö†Ô∏è Translations coming soon!
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Select Language:</label>
                        <select class="text-input" onchange="changeLanguage(this.value)" style="cursor: pointer;">
                            <option value="es" ${selectedLang === 'es' ? 'selected' : ''}>üá™üá∏ Spanish</option>
                            <option value="fr" ${selectedLang === 'fr' ? 'selected' : ''}>üá´üá∑ French</option>
                            <option value="de" ${selectedLang === 'de' ? 'selected' : ''}>üá©üá™ German</option>
                            <option value="zh-CN" ${selectedLang === 'zh-CN' ? 'selected' : ''}>üá®üá≥ Chinese</option>
                            <option value="ja" ${selectedLang === 'ja' ? 'selected' : ''}>üáØüáµ Japanese</option>
                        </select>
                    </div>
                    
                    <div class="info-content">
                        <p><strong>Meaning:</strong><br>${idiom.meaning}</p>
                        <p style="margin-top: 15px; font-size: 12px; color: #999; font-style: italic;">
                            (Full translations coming soon)
                        </p>
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('answer')">Continue</button>
                `;
            }
        }

        // ==========================================
        // HELPER FUNCTIONS
        // ==========================================
        
        function renderMedia(idiom) {
            if (idiom.image) {
                if (idiom.image.endsWith('.mp4')) {
                    return `<video src="${idiom.image}" autoplay loop muted playsinline style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;"></video>`;
                } else {
                    return `<img src="${idiom.image}" alt="${idiom.text}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 18px;">`;
                }
            }
            return `<div class="emoji-placeholder">${idiom.emoji}</div>`;
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function isIdiomCompleted(index) {
            // Check localStorage for completed idioms
            const completed = JSON.parse(localStorage.getItem('completedIdioms') || '[]');
            return completed.includes(index);
        }
        
        function markIdiomCompleted(index) {
            const completed = JSON.parse(localStorage.getItem('completedIdioms') || '[]');
            if (!completed.includes(index)) {
                completed.push(index);
                localStorage.setItem('completedIdioms', JSON.stringify(completed));
            }
        }
        
        function generateBlanksText() {
            const words = idiom.text.split(' ');
            const answers = idiom.blanks.answers;
            let blankIndex = 0;
            
            return words.map(word => {
                if (answers.includes(word)) {
                    blankIndex++;
                    return `<input type="text" class="blank-input" id="blank${blankIndex}" 
                                   value="${state['blank' + blankIndex] || ''}" 
                                   oninput="updateBlank('blank${blankIndex}', this.value)"
                                   placeholder="?" autocomplete="off">`;
                }
                return word;
            }).join(' ');
        }

        // ==========================================
        // GAME ACTIONS
        // ==========================================
        
        function goToScreen(screen) {
            // When going back to landing, reset to today's idiom
            if (screen === 'landing') {
                state.isPlayingArchive = false;
                state.archiveIdiomIndex = null;
                currentIdiomIndex = getTodaysIdiomIndex();
                idiom = idiomLibrary[currentIdiomIndex];
            }
            state.screen = screen;
            render();
        }
        
        function setTab(tab) {
            state.activeTab = tab;
            render();
        }
        
        function selectDifficulty(level) {
            state.difficulty = level;
            state.shuffledWords = null; // Reset for new game
            state.selectedWords = [];
            state.usedWordIndices = [];
            state.screen = 'solve';
            render();
        }
        
        function addWordByIndex(index, word) {
            if (!state.usedWordIndices.includes(index)) {
                state.selectedWords.push(word);
                state.usedWordIndices.push(index);
                render();
            }
        }
        
        function removeWord(selectedIndex) {
            state.selectedWords.splice(selectedIndex, 1);
            state.usedWordIndices.splice(selectedIndex, 1);
            render();
        }
        
        function updateBlank(field, value) {
            state[field] = value;
        }
        
        function updateAnswer(value) {
            state.userAnswer = value;
        }
        
        function checkAnswer() {
            let correct = false;
            
            if (state.difficulty === 'easy') {
                const userPhrase = state.selectedWords.join(' ').toLowerCase();
                correct = userPhrase === idiom.text;
            } else if (state.difficulty === 'medium') {
                const answers = idiom.blanks.answers;
                correct = answers.every((answer, index) => {
                    const blankValue = state['blank' + (index + 1)];
                    return blankValue && blankValue.toLowerCase().trim() === answer.toLowerCase();
                });
            } else if (state.difficulty === 'hard') {
                // Normalise user answer: lowercase, trim, strip punctuation
                let userAnswer = state.userAnswer.toLowerCase().trim()
                    .replace(/[.,!?;:'"-]/g, '')  // Remove punctuation
                    .replace(/^to\s+/, '');        // Remove leading "to "
                
                correct = (idiom.hardModeAccepts || [idiom.text]).some(accept => {
                    let normalised = accept.toLowerCase().trim()
                        .replace(/[.,!?;:'"-]/g, '')
                        .replace(/^to\s+/, '');
                    return normalised === userAnswer;
                });
            }
            
            state.isCorrect = correct;
            
            // In debug mode, don't save progress (allows testing all idioms freely)
            const isDebugMode = getDebugDayOverride() !== null;
            
            if (!isDebugMode) {
                // Always mark the idiom as completed
                markIdiomCompleted(currentIdiomIndex);
                
                // Only update streak/XP/today for today's idiom (not archive)
                if (!state.hasPlayedToday && !state.isPlayingArchive) {
                    state.streak++; // Streak always goes up on completion
                    if (correct) {
                        state.totalXP += XP_VALUES[state.difficulty]; // XP only if correct
                    }
                    saveProgress();
                    markTodayComplete();
                }
            }
            
            state.activeTab = 'meaning';
            state.screen = 'answer';
            render();
        }
        
        function startPractice() {
            state.screen = 'difficulty';
            state.difficulty = null;
            state.selectedWords = [];
            state.usedWordIndices = [];
            state.shuffledWords = null;
            state.userAnswer = '';
            state.blank1 = '';
            state.blank2 = '';
            state.blank3 = '';
            render();
        }
        
        function playArchiveIdiom(index) {
            currentIdiomIndex = index;
            idiom = idiomLibrary[index];
            state.isPlayingArchive = true;
            state.archiveIdiomIndex = index;
            state.screen = 'difficulty';
            state.difficulty = null;
            state.selectedWords = [];
            state.usedWordIndices = [];
            state.shuffledWords = null;
            state.userAnswer = '';
            state.blank1 = '';
            state.blank2 = '';
            state.blank3 = '';
            render();
        }
        
        function changeLanguage(lang) {
            state.selectedLanguage = lang;
            render();
        }

        // ==========================================
        // SHARING
        // ==========================================
        
        async function shareResult() {
            const difficultyStars = state.difficulty === 'easy' ? '‚≠ê' : state.difficulty === 'medium' ? '‚≠ê‚≠ê' : '‚≠ê‚≠ê‚≠ê';
            const difficultyLabel = state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1);
            
            const text = `I solved today's Daily Idiom! üéâ

${difficultyStars} ${difficultyLabel}
üî• ${state.streak} day streak
‚ö° ${state.totalXP} XP

Can you solve it?
https://dailyidiom.com

@dailyidiomgame`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        text: text,
                        url: 'https://dailyidiom.com'
                    });
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Share failed, falling back to clipboard');
                    }
                }
            }
            
            try {
                await navigator.clipboard.writeText(text);
                showToast('üìã Copied to clipboard!');
            } catch (err) {
                showToast('Unable to share');
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--green);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                font-family: 'Nunito', sans-serif;
                font-weight: 700;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ==========================================
        // INITIALIZE
        // ==========================================
        
        window.onload = () => render();
    </script>
</body>
</html>
