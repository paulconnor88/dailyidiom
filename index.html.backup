<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Village Idiom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .image-container {
            width: 100%;
            height: 300px;
            background: #f0f0f0;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .idiom-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated; /* For pixel art */
        }
        
        .placeholder-image {
            text-align: center;
            color: #999;
            font-size: 60px;
        }
        
        .placeholder-image-text {
            font-size: 14px;
            margin-top: 10px;
        }
        
        .difficulty-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-difficulty {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-difficulty:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            width: 100%;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .word-tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .word-tile {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .word-tile:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .word-tile.selected {
            background: #e0e0e0;
            color: #999;
            cursor: default;
        }
        
        .word-tile.selected:hover {
            transform: none;
        }
        
        .answer-area {
            background: #f9f9f9;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            min-height: 80px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
        }
        
        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .language-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .language-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .fill-blanks {
            font-size: 18px;
            line-height: 1.8;
            text-align: center;
        }
        
        .blank-input {
            display: inline-block;
            border: none;
            border-bottom: 2px solid #667eea;
            background: transparent;
            font-size: 18px;
            padding: 2px 8px;
            margin: 0 5px;
            width: 120px;
            text-align: center;
        }
        
        .blank-input:focus {
            outline: none;
            border-bottom-color: #764ba2;
        }
        
        .result {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .result-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }
        
        .result-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .result-text.correct {
            color: #10b981;
        }
        
        .result-text.incorrect {
            color: #ef4444;
        }
        
        .correct-answer {
            font-size: 18px;
            color: #666;
            margin-top: 10px;
        }
        
        .learning-content {
            margin-bottom: 25px;
        }
        
        .learning-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .learning-text {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
        }
        
        .idiom-display {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 25px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .share-button {
            background: #1DA1F2;
            color: white;
            margin-bottom: 10px;
        }
        
        .share-button:hover {
            background: #1a8cd8;
        }
        
        .tomorrow-message {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group .btn {
            flex: 1;
        }
        
        .archive-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .archive-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .archive-emoji {
            font-size: 40px;
            margin-right: 15px;
        }
        
        .archive-details {
            flex: 1;
        }
        
        .archive-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        
        .archive-subtitle {
            font-size: 12px;
            color: #999;
        }
        
        .archive-arrow {
            color: #667eea;
            font-size: 20px;
        }
        
        @keyframes slideIn {
            from {
                transform: translate(-50%, -100px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -100px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="game-container"></div>

    <script>
        // Game state
        let state = {
            screen: 'landing',
            difficulty: null,
            selectedWords: [],
            usedWordIndices: [], // Track which word tiles have been used
            userAnswer: '',
            blank1: '',
            blank2: '',
            blank3: '',
            isCorrect: false,
            streak: parseInt(localStorage.getItem('idiomStreak') || '0'),
            hasPlayedToday: localStorage.getItem('lastPlayedDay') === getDayOfYear().toString(),
            selectedLanguage: 'es',
            translatedContent: null,
            lastTranslatedLang: null
        };

        // Save streak to localStorage
        function saveStreak() {
            localStorage.setItem('idiomStreak', state.streak.toString());
            localStorage.setItem('lastPlayedDay', getDayOfYear().toString());
        }

        // Check if user completed today
        function markTodayComplete() {
            localStorage.setItem('lastPlayedDay', getDayOfYear().toString());
            state.hasPlayedToday = true;
        }

        // Library of idioms
        const idiomLibrary = [
            {
                id: 1,
                text: "break the ice",
                meaning: "To do or say something to make people feel more comfortable in a social situation, especially when meeting for the first time.",
                etymology: "This phrase dates back to the 1500s. Ships would sometimes get stuck in frozen waters, and smaller boats called 'icebreakers' would go ahead to break up the ice and clear a path. The metaphor was extended to social situations - someone needed to 'break the ice' to get conversation flowing smoothly.",
                words: ['break', 'the', 'ice'],
                blanks: { answers: ['break', 'ice'] },
                emoji: 'üßäüî®',
                image: 'idiom_images_pixel/idiom_01_break_the_ice.png'
            },
            {
                id: 2,
                text: "spill the beans",
                meaning: "To reveal secret information, either accidentally or deliberately.",
                etymology: "The origin is debated, but one theory suggests it comes from an ancient Greek voting method where white beans meant 'yes' and black beans meant 'no'. If someone knocked over the jar before votes were counted, they would 'spill the beans' and reveal the results early. First recorded use in English was in the early 1900s.",
                words: ['spill', 'the', 'beans'],
                blanks: { answers: ['spill', 'beans'] },
                emoji: 'ü´òüíß'
            },
            {
                id: 3,
                text: "piece of cake",
                meaning: "Something that is very easy to do.",
                etymology: "This phrase originated in the United States in the 1870s. It may reference cakewalks, competitions where the prize was a cake, or simply the idea that eating cake is easy and pleasant. The Royal Air Force popularised it in the 1930s-40s as slang for an easy mission.",
                words: ['piece', 'of', 'cake'],
                blanks: { answers: ['piece', 'cake'] },
                emoji: 'üç∞‚ú®'
            },
            {
                id: 4,
                text: "bite the bullet",
                meaning: "To force yourself to do something difficult or unpleasant that you have been avoiding.",
                etymology: "This phrase comes from battlefield medicine before anaesthesia was widely available. Soldiers undergoing surgery would literally bite down on a bullet to help cope with the pain. The practice was common during the American Civil War in the 1860s.",
                words: ['bite', 'the', 'bullet'],
                blanks: { answers: ['bite', 'bullet'] },
                emoji: 'ü¶∑üí£'
            },
            {
                id: 5,
                text: "hit the nail on the head",
                meaning: "To describe exactly what is causing a situation or problem; to be exactly right about something.",
                etymology: "This phrase has been used since at least the 1500s. It comes from carpentry - hitting a nail precisely on its head drives it in effectively, whilst missing causes damage. The metaphor was quickly adopted to mean getting something exactly right.",
                words: ['hit', 'the', 'nail', 'on', 'the', 'head'],
                blanks: { answers: ['nail', 'head'] },
                emoji: 'üî®üíÖ'
            },
            {
                id: 6,
                text: "let the cat out of the bag",
                meaning: "To reveal a secret, usually accidentally.",
                etymology: "Dating from the 1700s, this phrase likely comes from a market fraud where piglets were sold in bags. Dishonest merchants would substitute a cat, and if the buyer opened the bag before leaving, they would 'let the cat out of the bag' and discover the deception. The secret would be revealed.",
                words: ['let', 'the', 'cat', 'out', 'of', 'the', 'bag'],
                blanks: { answers: ['cat', 'bag'] },
                emoji: 'üê±üëú'
            },
            {
                id: 7,
                text: "raining cats and dogs",
                meaning: "Raining very heavily.",
                etymology: "The origin is uncertain, but there are several theories. One suggests that in 17th century England, heavy rain would wash dead animals through the streets, making it appear they had fallen from the sky. Another theory links it to Norse mythology where cats represented rain and dogs represented wind. First recorded in Jonathan Swift's writings in 1738.",
                words: ['raining', 'cats', 'and', 'dogs'],
                blanks: { answers: ['cats', 'dogs'] },
                emoji: 'üê±üêï‚òî'
            },
            {
                id: 8,
                text: "costs an arm and a leg",
                meaning: "Very expensive.",
                etymology: "Despite popular belief linking it to portrait painting prices, this phrase is actually quite modern, appearing after World War II in the 1940s. It likely emerged from wartime, where soldiers literally gave arms and legs, creating a powerful metaphor for the highest possible cost.",
                words: ['costs', 'an', 'arm', 'and', 'a', 'leg'],
                blanks: { answers: ['arm', 'leg'] },
                emoji: 'üí™ü¶µüí∞'
            },
            {
                id: 9,
                text: "under the weather",
                meaning: "Feeling ill or unwell.",
                etymology: "This phrase comes from maritime language. When sailors felt seasick, they would go below deck to get away from the weather and rough seas. Being 'under the weather' literally meant being below deck, sheltered from the elements, because you felt unwell. First used in this sense in the early 1800s.",
                words: ['under', 'the', 'weather'],
                blanks: { answers: ['under', 'weather'] },
                emoji: '‚òÅÔ∏èü§í'
            },
            {
                id: 10,
                text: "kick the bucket",
                meaning: "To die.",
                etymology: "There are several theories about this morbid phrase from the 1700s. One suggests it comes from the wooden frame (bucket) that pigs stood on before slaughter - when it was kicked away, they would hang. Another theory relates to people standing on a bucket to hang themselves, then kicking it away.",
                words: ['kick', 'the', 'bucket'],
                blanks: { answers: ['kick', 'bucket'] },
                emoji: 'ü™£üëû'
            },
            {
                id: 11,
                text: "barking up the wrong tree",
                meaning: "To pursue a mistaken or misguided course of action; to be wrong about the reason for something.",
                etymology: "This American phrase from the early 1800s comes from hunting. Dogs would chase prey up trees and bark at the base. Sometimes the animal would escape to another tree, but the dog would keep barking at the wrong one. Coon hunting was particularly associated with this phenomenon.",
                words: ['barking', 'up', 'the', 'wrong', 'tree'],
                blanks: { answers: ['barking', 'tree'] },
                emoji: 'üêïüå≥'
            },
            {
                id: 12,
                text: "kill two birds with one stone",
                meaning: "To achieve two goals with a single action.",
                etymology: "This phrase dates back to the 1600s and is found in similar forms across many languages. It likely originated from hunting, where throwing a stone and hitting two birds at once would be remarkably efficient. The phrase emphasises cleverness and efficiency in problem-solving.",
                words: ['kill', 'two', 'birds', 'with', 'one', 'stone'],
                blanks: { answers: ['two', 'birds', 'stone'] },
                emoji: 'ü™®üê¶üê¶'
            },
            {
                id: 13,
                text: "the ball is in your court",
                meaning: "It is your turn to take action or make a decision; the responsibility now lies with you.",
                etymology: "This phrase comes from tennis and similar court sports, emerging in the mid-1900s. When the ball is literally in your court, you must respond - you cannot wait for the other player to act. The metaphor perfectly captures the transfer of responsibility.",
                words: ['the', 'ball', 'is', 'in', 'your', 'court'],
                blanks: { answers: ['ball', 'court'] },
                emoji: 'üéæ‚öñÔ∏è'
            },
            {
                id: 14,
                text: "caught between a rock and a hard place",
                meaning: "Faced with two equally difficult choices.",
                etymology: "This American phrase appeared in the early 1900s, but the concept is ancient. It may come from Homer's Odyssey, where sailors had to navigate between Scylla (a rock) and Charybdis (a whirlpool). The modern phrase emphasises being trapped between two undesirable options.",
                words: ['caught', 'between', 'a', 'rock', 'and', 'a', 'hard', 'place'],
                blanks: { answers: ['rock', 'hard', 'place'] },
                emoji: 'ü™®üò∞ü™®'
            },
            {
                id: 15,
                text: "burning bridges",
                meaning: "To destroy relationships or opportunities, making it impossible to return to a previous situation.",
                etymology: "This phrase has military origins. Armies would literally burn bridges after crossing them to prevent enemy pursuit or to prevent their own retreat, forcing commitment to moving forward. The metaphor has been used figuratively since the 1800s to describe irreversible actions in relationships or careers.",
                words: ['burning', 'bridges'],
                blanks: { answers: ['burning', 'bridges'] },
                emoji: 'üåâüî•'
            },
            {
                id: 16,
                text: "break a leg",
                meaning: "Good luck (especially said to actors before a performance).",
                etymology: "This theatre superstition dates to the early 1900s. In theatre, wishing someone 'good luck' is considered bad luck, so the opposite is said instead. One theory suggests it refers to bending (breaking) your leg in a bow after a successful performance. Another links it to understudies hoping the main actor would break their leg so they could perform.",
                words: ['break', 'a', 'leg'],
                blanks: { answers: ['break', 'leg'] },
                emoji: 'ü¶µüí•'
            },
            {
                id: 17,
                text: "a blessing in disguise",
                meaning: "Something that seems bad or unlucky at first but turns out to be good.",
                etymology: "This phrase comes from a 1746 hymn by James Hervey: 'O ye mysterious Joys, whose very Darknesses are filled with Light, ye are indeed but Blessings in Disguise.' The idea that difficult experiences can bring unexpected benefits has been a philosophical concept for centuries.",
                words: ['a', 'blessing', 'in', 'disguise'],
                blanks: { answers: ['blessing', 'disguise'] },
                emoji: 'üé≠üëº'
            },
            {
                id: 18,
                text: "the elephant in the room",
                meaning: "An obvious problem or controversial issue that people avoid discussing.",
                etymology: "This phrase emerged in the 1950s, though the metaphor of an elephant representing something large and impossible to ignore is older. The phrase highlights how people can collectively pretend not to see even the most obvious problems when they are uncomfortable to address.",
                words: ['the', 'elephant', 'in', 'the', 'room'],
                blanks: { answers: ['elephant', 'room'] },
                emoji: 'üêòüõãÔ∏è'
            },
            {
                id: 19,
                text: "once in a blue moon",
                meaning: "Very rarely; almost never.",
                etymology: "A 'blue moon' is the second full moon in a calendar month, which happens approximately every 2-3 years. The moon doesn't actually appear blue. The phrase has been used since the 1800s to describe rare events. The astronomical definition was actually a mistake from 1946 that became widely accepted.",
                words: ['once', 'in', 'a', 'blue', 'moon'],
                blanks: { answers: ['blue', 'moon'] },
                emoji: 'üåôüíô'
            },
            {
                id: 20,
                text: "teaching your grandmother to suck eggs",
                meaning: "Giving advice to someone who is more experienced than you about something they already know well. It's presumptuous and often annoying.",
                etymology: "This phrase dates back to the early 1700s. Eggs were a precious food, and the skill of sucking out their contents without breaking the shell was common knowledge. Teaching this to a grandmother (someone with decades of experience) would be absurd and insulting.",
                words: ['teaching', 'your', 'grandmother', 'to', 'suck', 'eggs'],
                blanks: { answers: ['grandmother', 'suck', 'eggs'] },
                emoji: 'üëµü•ö'
            }
        ];

        // Current idiom selection based on day of year
        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function getTodaysIdiomIndex() {
            // Get day of year and mod by library length for cycling
            const dayOfYear = getDayOfYear();
            return dayOfYear % idiomLibrary.length;
        }

        let currentIdiomIndex = getTodaysIdiomIndex();
        let idiom = idiomLibrary[currentIdiomIndex];

        function render() {
            const app = document.getElementById('app');
            
            if (state.screen === 'landing') {
                const alreadyPlayedMessage = state.hasPlayedToday ? 
                    `<div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; color: #856404;">
                        ‚úÖ You've already completed today's idiom!<br/>
                        Come back tomorrow for a new challenge.
                    </div>` : '';
                
                app.innerHTML = `
                    <div class="header">
                        <div class="logo">üèòÔ∏è Daily Idiom</div>
                        <div class="subtitle">Daily English Idiom Challenge</div>
                    </div>
                    
                    ${alreadyPlayedMessage}
                    
                    <div class="image-container">
                        ${idiom.image ? 
                            `<img src="${idiom.image}" alt="${idiom.text}" class="idiom-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <div class="placeholder-image" style="display: none;">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                                 <div class="placeholder-image-text">Today's Idiom</div>
                             </div>`
                            :
                            `<div class="placeholder-image">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                                 <div class="placeholder-image-text">Today's Idiom</div>
                             </div>`
                        }
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('difficulty')">
                        ${state.hasPlayedToday ? 'Play Again (Practice Mode)' : "Start Today's Challenge"}
                    </button>
                    
                    ${state.streak > 0 ? `
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="font-size: 32px;">üî• ${state.streak}</div>
                            <div style="color: #666; font-size: 14px;">Day Streak</div>
                        </div>
                    ` : ''}
                    
                    <button class="btn btn-secondary" onclick="goToScreen('archive')" style="margin-top: 15px;">
                        üìö Browse All Idioms
                    </button>
                    
                    <div style="text-align: center; margin-top: 20px; color: #999; font-size: 14px;">
                        A new idiom every day! Come back tomorrow.
                    </div>
                `;
            }
            
            else if (state.screen === 'difficulty') {
                app.innerHTML = `
                    <div class="header">
                        <div class="logo">Choose Your Difficulty</div>
                    </div>
                    
                    <div class="image-container">
                        ${idiom.image ? 
                            `<img src="${idiom.image}" alt="${idiom.text}" class="idiom-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <div class="placeholder-image" style="display: none;">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                             </div>`
                            :
                            `<div class="placeholder-image">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                             </div>`
                        }
                    </div>
                    
                    <div class="difficulty-buttons">
                        <button class="btn btn-difficulty" onclick="selectDifficulty('easy')">
                            <strong>Easy</strong><br/>
                            <small>Reorder</small>
                        </button>
                        <button class="btn btn-difficulty" onclick="selectDifficulty('medium')">
                            <strong>Medium</strong><br/>
                            <small>Fill Blanks</small>
                        </button>
                        <button class="btn btn-difficulty" onclick="selectDifficulty('hard')">
                            <strong>Hard</strong><br/>
                            <small>Type It</small>
                        </button>
                    </div>
                `;
            }
            
            else if (state.screen === 'solve') {
                let solveContent = '';
                
                if (state.difficulty === 'easy') {
                    const shuffled = [...idiom.words].sort(() => Math.random() - 0.5);
                    // Track which word tiles have been used by index
                    const usedIndices = state.usedWordIndices || [];
                    
                    solveContent = `
                        <div class="answer-area" id="answerArea">
                            ${state.selectedWords.length === 0 ? 
                                '<div style="color: #999;">Tap words below to build the idiom</div>' :
                                state.selectedWords.map((w, i) => 
                                    `<div class="word-tile" onclick="removeWord(${i})">${w}</div>`
                                ).join('')
                            }
                        </div>
                        
                        <div class="word-tiles">
                            ${shuffled.map((word, index) => 
                                `<div class="word-tile ${usedIndices.includes(index) ? 'selected' : ''}" 
                                     onclick="addWordByIndex(${index}, '${word}')">
                                    ${word}
                                </div>`
                            ).join('')}
                        </div>
                    `;
                }
                
                else if (state.difficulty === 'medium') {
                    const blanksText = generateBlanksText();
                    solveContent = `
                        <div class="fill-blanks">
                            ${blanksText}
                        </div>
                    `;
                }
                
                else if (state.difficulty === 'hard') {
                    solveContent = `
                        <div class="input-group">
                            <label class="input-label">Type the complete idiom:</label>
                            <input type="text" class="text-input" id="userAnswer"
                                   value="${state.userAnswer}"
                                   oninput="updateAnswer(this.value)"
                                   placeholder="Enter the idiom...">
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <div class="header">
                        <div class="logo">Solve the Idiom</div>
                        <div class="subtitle">${state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1)} Mode</div>
                    </div>
                    
                    <div class="image-container">
                        ${idiom.image ? 
                            `<img src="${idiom.image}" alt="${idiom.text}" class="idiom-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <div class="placeholder-image" style="display: none;">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                             </div>`
                            :
                            `<div class="placeholder-image">
                                 <div style="font-size: 80px;">${idiom.emoji}</div>
                             </div>`
                        }
                    </div>
                    
                    ${solveContent}
                    
                    <button class="btn btn-primary" onclick="checkAnswer()">
                        Check Answer
                    </button>
                `;
            }
            
            else if (state.screen === 'result') {
                app.innerHTML = `
                    <div class="result">
                        <div class="result-icon">${state.isCorrect ? 'üéâ' : 'üòÖ'}</div>
                        <div class="result-text ${state.isCorrect ? 'correct' : 'incorrect'}">
                            ${state.isCorrect ? 'Correct!' : 'Not quite!'}
                        </div>
                        ${!state.isCorrect ? 
                            `<div class="correct-answer">
                                The answer was: <strong>${idiom.text}</strong>
                            </div>` : ''
                        }
                    </div>
                    
                    ${state.isCorrect ? 
                        `<button class="btn btn-secondary" onclick="shareResult()" style="margin-bottom: 10px;">
                            üì§ Share Result
                        </button>` : ''
                    }
                    
                    <button class="btn btn-primary" onclick="goToScreen('learn1')">
                        Learn More
                    </button>
                `;
            }
            
            else if (state.screen === 'learn1') {
                app.innerHTML = `
                    <div class="idiom-display">
                        "${idiom.text}"
                    </div>
                    
                    <div class="learning-content">
                        <div class="learning-title">What it means</div>
                        <div class="learning-text">${idiom.meaning}</div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('learn2')">
                        Next
                    </button>
                `;
            }
            
            else if (state.screen === 'learn2') {
                app.innerHTML = `
                    <div class="idiom-display">
                        "${idiom.text}"
                    </div>
                    
                    <div class="learning-content">
                        <div class="learning-title">Where it comes from</div>
                        <div class="learning-text">${idiom.etymology}</div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="goToScreen('translate')">
                            üåê Translate
                        </button>
                        <button class="btn btn-primary" onclick="goToScreen('sentence')">
                            Next
                        </button>
                    </div>
                `;
            }
            
            else if (state.screen === 'translate') {
                const selectedLang = state.selectedLanguage || 'es';
                
                app.innerHTML = `
                    <div class="idiom-display">
                        "${idiom.text}"
                    </div>
                    
                    <div class="learning-content">
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; color: #856404;">
                            ‚ö†Ô∏è Translations are AI-generated and may not be 100% accurate
                        </div>
                        
                        <label class="input-label">Select Language:</label>
                        <select id="languageSelect" class="language-select" onchange="changeLanguage(this.value)">
                            <option value="es" ${selectedLang === 'es' ? 'selected' : ''}>üá™üá∏ Spanish (Espa√±ol)</option>
                            <option value="fr" ${selectedLang === 'fr' ? 'selected' : ''}>üá´üá∑ French (Fran√ßais)</option>
                            <option value="de" ${selectedLang === 'de' ? 'selected' : ''}>üá©üá™ German (Deutsch)</option>
                            <option value="it" ${selectedLang === 'it' ? 'selected' : ''}>üáÆüáπ Italian (Italiano)</option>
                            <option value="pt" ${selectedLang === 'pt' ? 'selected' : ''}>üáµüáπ Portuguese (Portugu√™s)</option>
                            <option value="zh-CN" ${selectedLang === 'zh-CN' ? 'selected' : ''}>üá®üá≥ Chinese (‰∏≠Êñá)</option>
                            <option value="ja" ${selectedLang === 'ja' ? 'selected' : ''}>üáØüáµ Japanese (Êó•Êú¨Ë™û)</option>
                            <option value="ko" ${selectedLang === 'ko' ? 'selected' : ''}>üá∞üá∑ Korean (ÌïúÍµ≠Ïñ¥)</option>
                            <option value="ar" ${selectedLang === 'ar' ? 'selected' : ''}>üá∏üá¶ Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                            <option value="ru" ${selectedLang === 'ru' ? 'selected' : ''}>üá∑üá∫ Russian (–†—É—Å—Å–∫–∏–π)</option>
                        </select>
                        
                        <div id="translationContent" style="margin-top: 20px;">
                            ${state.translatedContent || '<div style="text-align: center; color: #999;">Translating...</div>'}
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('sentence')">
                        Continue
                    </button>
                `;
                
                // Trigger translation if not already done
                if (!state.translatedContent || state.lastTranslatedLang !== selectedLang) {
                    translateContent(selectedLang);
                }
            }
            
            
            else if (state.screen === 'sentence') {
                // Generate example sentence for the idiom
                const exampleSentence = getExampleSentence(idiom.id);
                
                app.innerHTML = `
                    <div class="idiom-display">
                        "${idiom.text}"
                    </div>
                    
                    <div class="learning-content">
                        <div class="learning-title">Use it in a sentence</div>
                        <div class="learning-text" style="font-style: italic; background: #f9f9f9; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                            "${exampleSentence}"
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="goToScreen('complete')">
                        Finish
                    </button>
                `;
            }
            
            else if (state.screen === 'complete') {
                const shareText = generateShareText();
                
                app.innerHTML = `
                    <div class="header">
                        <div class="logo">Well Done! üéâ</div>
                    </div>
                    
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value">üî• ${state.streak}</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary share-button" onclick="shareResult()">
                        üì§ Share Your Result
                    </button>
                    
                    <button class="btn btn-secondary" onclick="goToScreen('archive')">
                        üìö Browse Past Idioms
                    </button>
                    
                    <div class="tomorrow-message">
                        ‚è∞ Check back tomorrow for a new idiom!
                    </div>
                `;
            }
            
            else if (state.screen === 'archive') {
                app.innerHTML = `
                    <div class="header">
                        <div class="logo">üìö Idiom Archive</div>
                        <div class="subtitle">Browse all idioms</div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        ${idiomLibrary.map((item, index) => `
                            <div class="archive-item" onclick="playIdiom(${index})">
                                <div class="archive-emoji">${item.emoji}</div>
                                <div class="archive-details">
                                    <div class="archive-title">${item.text}</div>
                                    <div class="archive-subtitle">Idiom #${index + 1}</div>
                                </div>
                                <div class="archive-arrow">‚ñ∂</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="btn btn-secondary" onclick="goToScreen('landing')">
                        ‚Üê Back to Today
                    </button>
                `;
            }
        }

        function goToScreen(screen) {
            state.screen = screen;
            render();
        }

        function switchIdiom(index) {
            currentIdiomIndex = index;
            idiom = idiomLibrary[currentIdiomIndex];
            reset();
        }

        function generateShareText() {
            const difficultyEmoji = {
                'easy': '‚≠ê',
                'medium': '‚≠ê‚≠ê',
                'hard': '‚≠ê‚≠ê‚≠ê'
            };
            
            const result = state.isCorrect ? '‚úÖ' : '‚ùå';
            const difficultyLabel = state.difficulty.charAt(0).toUpperCase() + state.difficulty.slice(1);
            
            return `I ${state.isCorrect ? 'solved' : 'tried'} today's Daily Idiom! üèòÔ∏è

${result} Idiom #${currentIdiomIndex + 1}
${difficultyEmoji[state.difficulty]} ${difficultyLabel} difficulty
üî• ${state.streak} day streak

Play today's idiom: [YOUR-URL-HERE]`;
        }

        async function shareResult() {
            const shareText = generateShareText();
            
            // Try native share first (works on mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        text: shareText,
                        url: window.location.href
                    });
                    showToast('Shared! üéâ');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Share failed, falling back to clipboard');
                    }
                }
            }
            
            // Fallback to clipboard
            try {
                await navigator.clipboard.writeText(shareText);
                showToast('üìã Copied to clipboard!');
            } catch (err) {
                // Final fallback - show text in alert
                alert('Share this:\n\n' + shareText);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #10b981;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function changeLanguage(lang) {
            state.selectedLanguage = lang;
            state.translatedContent = getTranslation(lang);
            render();
        }

        function playIdiom(index) {
            currentIdiomIndex = index;
            idiom = idiomLibrary[index];
            state.screen = 'difficulty';
            state.difficulty = null;
            state.selectedWords = [];
            state.usedWordIndices = [];
            state.userAnswer = '';
            state.blank1 = '';
            state.blank2 = '';
            state.blank3 = '';
            render();
        }

        function getTranslation(targetLang) {
            // Pre-written translations for better quality and reliability
            // For MVP, we'll provide Spanish and French, with a note that more are coming
            const translations = {
                'es': {
                    meaningTitle: 'Significado',
                    originTitle: 'Origen',
                    meaning: idiom.meaning, // Will be translated
                    origin: idiom.etymology  // Will be translated
                },
                'fr': {
                    meaningTitle: 'Signification',
                    originTitle: 'Origine',
                    meaning: idiom.meaning,
                    origin: idiom.etymology
                }
            };
            
            // For now, just show English with translated labels
            // In production, you'd add real translations here
            const labels = {
                'es': { meaningTitle: 'Significado', originTitle: 'Origen' },
                'fr': { meaningTitle: 'Signification', originTitle: 'Origine' },
                'de': { meaningTitle: 'Bedeutung', originTitle: 'Herkunft' },
                'it': { meaningTitle: 'Significato', originTitle: 'Origine' },
                'pt': { meaningTitle: 'Significado', originTitle: 'Origem' },
                'zh-CN': { meaningTitle: 'Âê´‰πâ', originTitle: 'Ëµ∑Ê∫ê' },
                'ja': { meaningTitle: 'ÊÑèÂë≥', originTitle: 'Áî±Êù•' },
                'ko': { meaningTitle: 'ÏùòÎØ∏', originTitle: 'Í∏∞Ïõê' },
                'ar': { meaningTitle: 'ÿßŸÑŸÖÿπŸÜŸâ', originTitle: 'ÿßŸÑÿ£ÿµŸÑ' },
                'ru': { meaningTitle: '–ó–Ω–∞—á–µ–Ω–∏–µ', originTitle: '–ü—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ' }
            };
            
            const lang = labels[targetLang] || labels['es'];
            
            return `
                <div style="margin-bottom: 20px;">
                    <div class="learning-title">${lang.meaningTitle}</div>
                    <div class="learning-text">${idiom.meaning}</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #999; font-style: italic;">
                        (English text shown - full translations coming soon)
                    </div>
                </div>
                <div>
                    <div class="learning-title">${lang.originTitle}</div>
                    <div class="learning-text">${idiom.etymology}</div>
                </div>
            `;
        }

        function getExampleSentence(idiomId) {
            // Example sentences for each idiom
            const examples = {
                1: "I tried to teach my boss about social media marketing, but I realized I was breaking the ice at the wrong time.",
                2: "Don't spill the beans about the surprise party!",
                3: "That exam was a piece of cake - I finished in 20 minutes.",
                4: "I had to bite the bullet and tell her the truth.",
                5: "You hit the nail on the head with that analysis.",
                6: "He accidentally let the cat out of the bag about the merger.",
                7: "It's raining cats and dogs outside, so bring an umbrella.",
                8: "That designer handbag costs an arm and a leg.",
                9: "I'm feeling a bit under the weather today, so I'll stay home.",
                10: "When the old computer finally kicked the bucket, we had to buy a new one.",
                11: "You're barking up the wrong tree if you think I took your keys.",
                12: "By carpooling, we can kill two birds with one stone - save money and help the environment.",
                13: "I've done everything I can; now the ball is in your court.",
                14: "She was caught between a rock and a hard place when choosing between the two job offers.",
                15: "Don't burn your bridges - you might need to work with them again someday.",
                16: "Break a leg in your performance tonight!",
                17: "Losing that job was a blessing in disguise - it led me to my dream career.",
                18: "Everyone knows about his drinking problem, but it's the elephant in the room that nobody mentions.",
                19: "My father only visits us once in a blue moon.",
                20: "I know you're experienced, but please don't take this as teaching your grandmother to suck eggs."
            };
            
            return examples[idiomId] || `Here's an example: The situation was perfect to use "${idiom.text}".`;
        }

        function generateBlanksText() {
            const words = idiom.text.split(' ');
            const answers = idiom.blanks.answers;
            let blankIndex = 0;
            
            return words.map(word => {
                if (answers.includes(word)) {
                    blankIndex++;
                    return `<input type="text" class="blank-input" id="blank${blankIndex}" 
                                   value="${state['blank' + blankIndex] || ''}" 
                                   oninput="updateBlank('blank${blankIndex}', this.value)"
                                   placeholder="?">`;
                }
                return word;
            }).join(' ');
        }

        function selectDifficulty(level) {
            state.difficulty = level;
            state.screen = 'solve';
            render();
        }

        function addWordByIndex(index, word) {
            if (!state.usedWordIndices.includes(index)) {
                state.selectedWords.push(word);
                state.usedWordIndices.push(index);
                render();
            }
        }

        function removeWord(selectedIndex) {
            // Remove from selected words and free up the tile
            const tileIndex = state.usedWordIndices[selectedIndex];
            state.selectedWords.splice(selectedIndex, 1);
            state.usedWordIndices.splice(selectedIndex, 1);
            render();
        }

        function updateBlank(field, value) {
            state[field] = value;
        }

        function updateAnswer(value) {
            state.userAnswer = value;
        }

        function checkAnswer() {
            let correct = false;
            
            if (state.difficulty === 'easy') {
                const userPhrase = state.selectedWords.join(' ').toLowerCase();
                correct = userPhrase === idiom.text;
            } else if (state.difficulty === 'medium') {
                // Check all blanks dynamically
                const answers = idiom.blanks.answers;
                correct = answers.every((answer, index) => {
                    const blankValue = state['blank' + (index + 1)];
                    return blankValue && blankValue.toLowerCase().trim() === answer.toLowerCase();
                });
            } else if (state.difficulty === 'hard') {
                correct = state.userAnswer.toLowerCase().trim() === idiom.text;
            }
            
            state.isCorrect = correct;
            if (correct && !state.hasPlayedToday) {
                state.streak++;
                saveStreak();
                markTodayComplete();
            }
            state.screen = 'result';
            render();
        }

        function reset() {
            state = {
                screen: 'landing',
                difficulty: null,
                selectedWords: [],
                usedWordIndices: [],
                userAnswer: '',
                blank1: '',
                blank2: '',
                blank3: '',
                isCorrect: false,
                streak: state.streak,
                hasPlayedToday: state.hasPlayedToday
            };
            render();
        }

        // Initialize on load
        window.onload = () => render();
    </script>
</body>
</html>
